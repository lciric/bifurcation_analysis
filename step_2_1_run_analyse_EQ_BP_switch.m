%% get the path 
currentFile = mfilename( 'fullpath' );
[path,~,~] = fileparts( currentFile );
path = strcat(path,"/EQ_Low_2nodes_6368_test_13nov_BPcont/");
if ~exist(path, 'dir')
   mkdir(path)
end

%% initialise parameters
nb_variable = 15;


%% initial conditions EQ_Low_2nodes_6368_test for both networks
%% xinit=[0.008879174261203, 0., 0.019163785974604, 0., 1.068724078078379e-07, 0., -8.672250240746687e-10, 0., 0., 0., 0., 8.617060187829917e-07, 0., 0., 4.912610906683856e-27, 0.]
%xinit=[0.008879174261203, 0, 0.019163785974604, 0, 1.068724078078379e-07, 0, -8.672250240746687e-10, 0, 0, 0, 0, 8.617060187829917e-07, 0, 0, 0, 0] 
external_input_EE =0;
%xinit=[0.008879180161425, 0., 0.019163825646130, 0., 2.299402178611073e-08, 0.,-1.171661775274857e-10, 0., 0., 0., 0, 1.469387303629773e-07, 0., 0., 0., 0.]

%xinit=[8.87917426237024e-003, 0.00000000000000e+000, 19.1637859766114e-003, 0., 106.872418634038e-009, 0., -867.224737268984e-012, 0., 0., 0., 0., 861.706015539962e-009, 0., 0., 4.44511416861913e-027, 0.]

%% middle fixed point EQ_Low_2nodes_6365_test

%xinit=[0.006736053894387, 0., 0.015150822465864, 0., 1.835155463305062e-08, 0., -9.895634928054641e-11, 0., 0., 0., 0., 1.313067180001039e-07, 0., 0., 9.648973008615702e-27, 0.]
%external_input_EE = 1.216509393226919e-07;

%% middle fixed point for 2 nodes EQ_Low_2nodes_6368_test

% external_input_EE = 0.; %1.389995245736951e-08;
%% xinit=[0.008879180161425, 0.008879180161425, 0.019163825646130, 0.019163825646130, 2.299402178611073e-08, 0., -1.171661775274857e-10, 0., 2.299402178611073e-08, 0., -1.171661775274857e-10, 1.469387303629773e-07, 0., 1.469387303629773e-07, 4.912610906683856e-27, 4.912610906683856e-27]
%xinit=[8.87907983747378e-003, 8.87907983747378e-003, 19.1635902452071e-003, 19.1635902452071e-003, 106.871018806924e-009, 6.36151493701332e-015, -867.198311687175e-012, 12.2675901367517e-015, 106.871018806924e-009, 12.2675901367517e-015, -867.198311687175e-012, 861.694561336529e-009, 28.9627487420918e-015, 861.694561336529e-009, 4.44511416861913e-027, 4.44511416861913e-027]
%% start end of branch
%xinit=[3.191119500563943e-05, 0.008879670724716, 3.995106096653439e-07, 0.019166979843912, 3.992254874696489e-10, 1.892538591061875e-12, 3.480995460683181e-15, 8.516873261223280e-14, 1.068780521619932e-07, 3.371461482312821e-14, -8.673540409024579e-10, 1.997546962974070e-11, -5.388927304338472e-17, 8.618343055465874e-07, 0, 0]

%% start HOPF 
%external_input_EE = 2.269354939363481e-04;
%xinit=[0.008979449853112, 0., 0.019818794486735, 0., 2.319414030630450e-08, 0., -1.169010326918319e-10, 0., 0., 0., 0., 1.487295647215445e-07, 0., 0., 8.738597067826070e-28, 0.]

%xinit = [0.006736054107679, 0.0, 0.015150822339961, 8.198467606967413e-08, 0.0, 0.0,0.0,0.0]; 
%xinit = [0.006736054107679, 0.015150822339961, 8.198467606967413e-08, -1.532611890622314e-09, 6.964807133401267e-07, 1.287659890135313e-26]
%xinit =[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
%xinit = [0.006736000522408, 0.006736000522408, 0.015150578926278, 0.015150578926278, 8.197803672841847e-08, 2.281397701635157e-19, -6.257745155506490e-10, 2.234205569798222e-19, 8.197803672837644e-08, 2.234193096528899e-19, -6.257745154900210e-10, 6.964736602327475e-07, 2.188359270794252e-19, 6.964736602327174e-07, 1.079543606100960e-26, 0.0]

%% start BRANCH POINT
xinit=[0.006345716273813, 0.006345716406824, 0.007204446707876, 0.007204447172617, 7.770472050159328e-08, -4.306035072978117e-10, -2.912360247931675e-10, -2.412078308087898e-10, 7.770472210556138e-08, -2.412078373630049e-10, -2.912359895495158e-10, 3.457075332090808e-07, -1.315749024737602e-12, 3.457075547211126e-07, -5.012832820307983e-14, 5.013183141489263e-14]
value=-0.023804853777094;

%% start away from BP, near Hopf
%xinit=[0.006391986897187, 0.006391986897296, 0.007366916128412, 0.007366916128791, 7.824460622020036e-08, -4.234984263850958e-10, -3.001481689598954e-10, -2.396456212785037e-10, 7.824460622143364e-08, -2.396456212798688e-10, -3.001481689972237e-10, 3.531962885865846e-07, -1.269982163112089e-12, 3.531962886038835e-07, -3.714470666113568e-25, 0];
%value=-0.023456661110925;

%% forward
folder = "start_Lazar";
MaxStepsize=1e-5;
MaxNumPoints_forward =100; %300000 %30000 %600000;%200000
MaxNumPoints_backward=100; %30000  %100000;%20000  
%value=0.;%-0.023804853777094;
[x1,f1,v1,s1,h1,x2,f2,v2,s2,h2]=Equilibrium_Point(path,folder,nb_variable,xinit',MaxStepsize,MaxNumPoints_forward,MaxNumPoints_backward,value);

%% continuation_branchpoint
folder = "continuation_branchpoint"
MaxStepsize=1e-6; %1e-6
MaxNumPoints_forward =20000;%200000;
MaxNumPoints_backward=20000;%20000; 
%xinit=x2(1:16,s2(2).index);
xinit=[6.34571678192884e-003, 6.34571618347675e-003, 7.20444848137052e-003, 7.20444639220674e-003, 77.7047264731459e-009, -430.603497681351e-012, -291.236078642989e-012, -241.207851946930e-012, 77.7047195080508e-009, -241.207832395428e-012, -291.235929043486e-012, 345.707615084570e-009, -1.31576198137937e-012, 345.707518750286e-009, -8.06121681821499e-012, 8.06119905227198e-012]
value=x2(17,s2(2).index);
%xinit=[0.006345716273813, 0.006345716406824, 0.007204446707876, 0.007204447172617, 7.770472050159328e-08, -4.306035072978117e-10, -2.912360247931675e-10, -2.412078308087898e-10, 7.770472210556138e-08, -2.412078373630049e-10, -2.912359895495158e-10, 3.457075332090808e-07, -1.315749024737602e-12, 3.457075547211126e-07, -5.012832820307983e-14, 5.013183141489263e-14]
%value=-0.023804853777094;

Branch_Point(path,folder,nb_variable,xinit', s2(2), 0.00001, MaxStepsize,MaxNumPoints_forward,MaxNumPoints_backward,value);

folder="cont_Lazar";
file="continuation_branchpoint/p_exc_AB_Lazar_f.mat";
number= 10;
MaxStepsize=1e-8;
MaxNumPoints_forward=2000; 
Equilibrium_Point_cont(path,folder,nb_variable,file,number,MaxStepsize,MaxNumPoints_forward,MaxNumPoints_backward);

folder="cont_Lazar_2";
file="cont_Lazar/p_exc_AB_Lazar_f.mat";
number= 0;
MaxStepsize=1e-5;
MaxNumPoints_forward=2000; 
Equilibrium_Point_cont(path,folder,nb_variable,file,number,MaxStepsize,MaxNumPoints_forward,MaxNumPoints_backward);

folder="cont_Lazar_3";
file="cont_Lazar_2/p_exc_AB_Lazar_b.mat";
number= 10;
MaxStepsize=1e-8;
MaxNumPoints_forward=-1; 
MaxNumPoints_backward=20000;
Equilibrium_Point_cont(path,folder,nb_variable,file,number,MaxStepsize,MaxNumPoints_forward,MaxNumPoints_backward);





