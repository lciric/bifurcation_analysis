%  Copyright 2021 Aix-Marseille Universit√©
% "Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements; and to You under the Apache License, Version 2.0. "
clear all

global cds sys
format longEng

%%%%% Set continuation pause environment variables %%%%%
%%
sys.gui.pausespecial=0;  %Pause at special points 
sys.gui.pausenever=1;    %Pause never 
sys.gui.pauseeachpoint=0; %Pause at each point

%%%%% Set system %%%%%
syshandle=@Zerlaut_adap;  %Specify system file

%%
%%%%% ODE Integration %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%% Define a few intermediate functions for ODE integration %%%%%
SubFunHandles=feval(syshandle);  %Get function handles from system file
RHShandle=SubFunHandles{2};      %Get function handle for ODE

%%%%%%%%%%%%%%%%%%%%%%%%%%%%Initialisation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[g_L,E_L_e,E_L_i,C_m,E_e,E_i,Q_e,Q_i,tau_e,tau_i,tau_w_e,b_e,N_tot,p_connect,p_exc_AB,p_exc_BA,p_inh_AB,p_inh_BA,g,T,external_input_E_E,external_input_E_I,P_e_0,P_e_1,P_e_2,P_e_3,P_e_4,P_e_5,P_e_6,P_e_7,P_e_8,P_e_9,P_i_0,P_i_1,P_i_2,P_i_3,P_i_4,P_i_5,P_i_6,P_i_7,P_i_8,P_i_9] = load_parameters_Lazar("./parameter_test_Lazar.mat");
p_exc_AB=0.0%02%0.01;
%p_inh_AB=0.001
E_L_e=-63.
E_L_i=-68.
%external_input_E_E=5.882607330582021e-08% fixed point 48.3319929397390e-006%5.882607330582021e-08%3.004074251324467e-08%-1.219329337793916e-07
%external_input_E_E=0.0%2.368606738980896e-04%1.00698511460197e-003%236.860673898090e-006;

%% middle fixed point for both nodes 
xinit=[0.008879180161425, 0.008879180161425, 0.019163825646130, 0.019163825646130, 2.299402178611073e-08, 0., -1.171661775274857e-10, 0., 2.299402178611073e-08, 0., -1.171661775274857e-10, 1.469387303629773e-07, 0., 1.469387303629773e-07, 4.912610906683856e-27, 4.912610906683856e-27]

%% middle fixed point 
external_input_EE = 0.; %1.389995245736951e-08;
%xinit=[0.008879180161425, 0., 0.019163825646130, 0., 2.299402178611073e-08, 0., -1.171661775274857e-10, 0., 0., 0., 0., 1.469387303629773e-07, 0., 0., 4.912610906683856e-27, 0.];
%xinit=[0.008879174261203, 0., 0.019163785974604, 0., 1.068724078078379e-07, 0., -8.672250240746687e-10, 0., 0., 0., 0., 8.617060187829917e-07, 0., 0., 4.912610906683856e-27, 0.]
xinit=[8.87917426237024e-003, 0.00000000000000e+000, 19.1637859766114e-003, 0., 106.872418634038e-009, 0., -867.224737268984e-012, 0., 0., 0., 0., 861.706015539962e-009, 0., 0., 4.44511416861913e-027, 0.]

%% initial point of EQ_Low_2nodes_6368
xinit=[0.008879174261203, 0, 0.019163785974604, 0, 1.068724078078379e-07, 0, -8.672250240746687e-10, 0, 0, 0, 0, 8.617060187829917e-07, 0, 0, 0, 0] 
external_input_EE = 0.

%% initial conditions EQ_Low_2nodes_6368_test for 1 node
%xinit=[0.008879174261203, 0., 0.019163785974604, 0., 1.068724078078379e-07, 0., -8.672250240746687e-10, 0., 0., 0., 0., 8.617060187829917e-07, 0., 0., 4.912610906683856e-27, 0.];
%external_input_EE = 0.;

%% initial conditions EQ_Low_2nodes_6368_test for both nodes
% external_input_EE = 0.
% xinit=[0.008879174261203, 0.008879174261203, 0.019163785974604, 0.019163785974604, 1.068724078078379e-07, 0., -8.672250240746687e-10, 0., 1.068724078078379e-07, 0., -8.672250240746687e-10, 8.617060187829917e-07, 0., 8.617060187829917e-07, 0., 0.]
                                                                                   %eaea                 %eaeb eaia                  eaib ebeb                  ebia ebib                    iaia                  iaib ibib
%% TEST 6368 FP
%% external_input_EE = 2.269354939363481e-04
%xinit=[0.008879180161425, 0., 0.019163825646130, 0.,
%2.299402178611073e-08, 0., -1.171661775274857e-10, 0., 0., 0., 0., 1.469387303629773e-07, 0., 0., 4.912610906683856e-27, 0.];
%% xinit=[0.0089, 0., 0.019, 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 4.912610906683856e-27, 0.]

%% 6368 HOPF
%external_input_EE = 2.269354939363481e-04;
%xinit=[0.008979449853112, 0., 0.019818794486735, 0., 2.319414030630450e-08, 0., -1.169010326918319e-10, 0., 0., 0., 0., 1.487295647215445e-07, 0., 0., 8.738597067826070e-28, 0.]


%xinit = [0.,0.0,0.0,0.0,0.0,0.0,0.,0.,0.,0.,0.,0.,0.,0.,0.,0.]; % test
% 1NODE xinit = [3.45432999849642e-003, 9.39513581484787e-003, 16.5141387100010e-006,35.2176982561329e-006,81.8757983637968e-006,0.00000000000000e+000]; % limit circle
%xinit = [3.45432999849642e-003, 3.45432999849642e-003, 9.39513581484787e-003, 9.39513581484787e-003, 16.5141387100010e-006, 0.00000000000000e+000, 35.2176982561329e-006, 0.00000000000000e+000, 16.5141387100010e-006, 0.00000000000000e+000, 35.2176982561329e-006, 81.8757983637968e-006,  0.00000000000000e+000, 81.8757983637968e-006, 0.00000000000000e+000, 0.00000000000000e+000];   % limit circle
        %[v_eA,                  v_eB,                  v_iA,                  v_iB,                  c_eAeA,                c_eAeB,                c_eAiA,                c_eAiB,                c_eBeB,                c_eBiA,                c_eBiB,                c_iAiA,                 c_iAiB,                c_iBiB,                w_eA,                  w_eB]
%xinit = [192.633343733407e-003, 192.633343733407e-003, 192.633343733407e-003, 192.633343733407e-003, 88.6955903317254e-009, 4.87672060835196e-012, 4.87672060835196e-012, 4.87672060835196e-012, 88.6955903317254e-009, 4.87672060835196e-012, 4.87672060835196e-012, 347.414969848884e-009, 347.414969848884e-009, 347.414969848884e-009, 0.00000000000000e+000, 0.00000000000000e+000];
%xinit = [196.374853328286e-003, 196.374853328286e-003, 196.380355662522e-003, 196.380355662522e-003, 88.6955903317254e-009, 0.00000000000000e+000, 4.87672060835196e-012, 0.00000000000000e+000, 88.6955903317254e-009, 0.00000000000000e+000, 4.87672060835196e-012, 347.414969848884e-009, 0.00000000000000e+000, 347.414969848884e-009, 0.00000000000000e+000, 0.00000000000000e+000];

%% TEST FP 6.7 HZ
%xinit = [0.006736054107679, 0.0, 0.015150822339961, 0.0, 8.198467606967413e-08, 0.0, -1.532611890622314e-09, 0.0, 0.0, 0.0, 0.0, 6.964807133401267e-07, 0.0, 0.0, 1.287659890135313e-26, 0.0]
%xinit = [0.002705506850324, 0.002705506850325, 0.006824067848885, 0.006824067848888, 3.365555341260969e-08, 4.822231879719104e-19, -2.778590228164688e-10, 6.375566566253969e-19, 3.365555341263254e-08, 6.375581603964771e-19, -2.778590228389288e-10, 3.274036526945201e-07, 8.435569493244830e-19, 3.274036526947421e-07, 1.582128834495516e-26, 0.0]
%xinit = [0.002705506850324, 0.000000000000000, 0.006824067848885, 0.000000000000000, 3.365555341260969e-08, 0.0000000000000000000, -2.778590228164688e-10, 0.0000000000000000000, 0.0000000000000000000, 0.0000000000000000000, 0.00000000000000000000, 3.274036526945201e-07, 0.0000000000000000000, 0.00000000000000000000, 1.582128834495516e-26, 0.0]

%xinit = [0.006736000, 0.0, 0.015150578926278, 0.0, 8.197803672841847e-08, 0.0, -6.257745155506490e-10, 0.0, 0.0, 0.0, 0.0, 6.964736602327475e-07, 0.0, 0.0, 1.287659890135313e-26, 0.0] %new TF coefficients, same params as Zerlaut and TVB

%% HOPF :
%xinit= [6.92894204280938e-003, 6.92894204279790e-003, 16.0469539539106e-003, 16.0469539538886e-003, 84.2285631467535e-009, 222.741934495448e-021, -664.256991710034e-012, 216.814754298234e-021, 84.2285631466274e-009,216.810828145999e-021, -664.256991804649e-012, 734.069018886413e-009, 211.036297930995e-021, 734.069018884266e-009, 2.94120572721322e-027, 1.76006729960460e-027]

%xinit= [7.45083067280463e-003, 7.45083067279817e-003, 18.6911616217764e-003, 18.6911616217647e-003, 90.2895788962400e-009, 210.604888482022e-021, -772.985324294682e-012, 201.934071032738e-021, 90.2895788961553e-009, 201.931423726966e-021, -772.985324261347e-012, 842.642743794098e-009, 193.638584864105e-021, 842.642743793519e-009, 3.06037084939508e-027, 0.00000000000000e+000]

%xinit = [2.73005011488410e-003, 2.73005011488367e-003, 6.99601536647486e-003, 6.99601536647420e-003, 33.9531810502384e-009, 468.030104759485e-021, -285.484520844040e-012, 618.120322784399e-021, 33.9531810502263e-009, 618.119587947848e-021, -285.484520845342e-012, 335.342434740872e-009, 816.189703963292e-021,335.342434740664e-009, -14.7304081156953e-027, 3.62248084824640e-027]

%eaeb     eaia                   eaib ebeb ebia  ebib iaia                  iaib  ibib   wea      web  
%     ea                  eb   ia                ib    eaea         


% xinit = [192.633343733407e-003, 192.792039966707e-003, 88.6955903317254e-009, 4.87672060835196e-012, 347.414969848884e-009, 0.00000000000000e+000]; % high fix point
%%%%%% Define an anynomous function to pass to integrator %%%%%
RHS_no_param=@(t,x)RHShandle(t,x,g_L,E_L_e,E_L_i,C_m,E_e,E_i,Q_e,Q_i,tau_e,tau_i,tau_w_e,b_e,N_tot,p_connect,p_exc_AB,p_exc_BA,p_inh_AB,p_inh_BA,g,T,external_input_E_E,external_input_E_I,P_e_0,P_e_1,P_e_2,P_e_3,P_e_4,P_e_5,P_e_6,P_e_7,P_e_8,P_e_9,P_i_0,P_i_1,P_i_2,P_i_3,P_i_4,P_i_5,P_i_6,P_i_7,P_i_8,P_i_9); 

%%%%% Set ODE integrator options %%%%%
options=odeset;
options=odeset(options,'MaxStep',1e-2);  %Set max step size
options=odeset(options,'InitialStep',1e-5); %Set Initial stepsize
options=odeset(options,'RelTol',1e-6);


% %%%%%% Integrate until a steady state is found. %%%%%
[tout xout]=ode45(RHS_no_param,[0,50],xinit,options);
figure()
%plot(tout,xout,'-k','linewidth',2)
plot(tout,xout(:,1),'DisplayName','v_{eA}')
hold on 
%plot(tout,xout(:,2),'DisplayName','v_{eB}')
%hold on 
plot(tout,xout(:,3),'DisplayName','v_{iA}')
hold on 
%plot(tout,xout(:,4),'DisplayName','v_{iB}')
xlabel('t(ms)')
ylabel('Firing rate (kHz)')
hold off
title('p_exc_AB=0.00, p_inh_AB=0.00, E_L_e=-63., E_L_i=-68.')
legend
xout(end,:)

% external_input_E_E=0.0e-3;
% external_input_I_E=0.0e-3;
% RHS_no_param_2=@(t,x)RHShandle(t,x,w_e,0.0,g_L,diff_E_L,E_L_i,C_m,E_e,E_i,Q_e,Q_i,tau_e,tau_i,N_tot,p_connect,g,T,external_input_E_E,external_input_E_I,external_input_I_E,external_input_I_I,P_e_0,P_e_1,P_e_2,P_e_3,P_e_4,P_e_5,P_e_6,P_e_7,P_e_8,P_e_9,P_i_0,P_i_1,P_i_2,P_i_3,P_i_4,P_i_5,P_i_6,P_i_7,P_i_8,P_i_9);
% [tout xout]=ode45(RHS_no_param_2,[0,500],xout(end,:),options);
% figure()
% plot(tout,xout,'-k','linewidth',2)
% xout(end,:)
% % axis([0 300 -1 1])
